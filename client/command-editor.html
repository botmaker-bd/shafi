<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Editor - Bot Maker Pro</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/command-editor.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Enhanced Command Editor Styles */
        .test-input-section {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .test-input-group {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        .test-input-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .test-examples {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .test-examples strong {
            color: var(--text-primary);
        }
        
        .test-result-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            background: var(--bg-secondary);
            margin-top: 1rem;
            position: relative;
        }
        
        .test-result-content {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .copy-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .copy-btn:hover {
            background: var(--primary-dark);
        }
        
        .telegram-message {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid var(--primary-color);
        }
        
        .message-user {
            border-left-color: var(--success-color);
        }
        
        .message-bot {
            border-left-color: var(--primary-color);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .message-content {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .template-preview {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .template-code-preview {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: var(--bg-primary);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
            overflow-x: auto;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .template-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
        
        .template-error {
            text-align: center;
            padding: 2rem;
            color: var(--error-color);
        }
        
        .command-group {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .command-group:hover {
            background: var(--bg-tertiary);
            transform: translateX(5px);
        }
        
        .command-group.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .command-patterns {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.1);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
        }
        
        .command-group.active .command-patterns {
            background: rgba(255,255,255,0.2);
        }
        
        .fullscreen-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            tab-size: 4;
        }
        
        .code-editor-container {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .code-editor-container textarea {
            border: none;
            resize: vertical;
            min-height: 200px;
        }
        
        .editor-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="dashboard.html" class="nav-brand">
                <span class="brand-icon">ðŸ¤–</span>
                <span class="brand-text">Bot Maker Pro</span>
            </a>
            
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-links" id="navLinks">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="bot-management.html" class="nav-link">
                    <i class="fas fa-robot"></i>
                    <span>My Bots</span>
                </a>
                <a href="command-editor.html" class="nav-link active">
                    <i class="fas fa-code"></i>
                    <span>Commands</span>
                </a>
                <a href="admin-settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                
                <div class="user-menu">
                    <button class="user-btn" id="userMenuBtn">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userEmail">user@example.com</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <a href="profile.html" class="dropdown-item">
                            <i class="fas fa-user-edit"></i> Edit Profile
                        </a>
                        <a href="change-password.html" class="dropdown-item">
                            <i class="fas fa-key"></i> Change Password
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" id="logoutBtn" class="dropdown-item">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <div class="header-content">
                <h1 id="botName">Command Editor</h1>
                <p id="botUsername">Create and manage bot commands</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="backToBots">
                    <i class="fas fa-arrow-left"></i> Back to Bots
                </button>
                <button class="btn btn-primary" id="quickTest">
                    <i class="fas fa-bolt"></i> Quick Test
                </button>
            </div>
        </div>

        <div class="editor-layout">
            <!-- Sidebar -->
            <div class="commands-sidebar">
                <div class="sidebar-header">
                    <h3>Commands</h3>
                    <button id="addCommandBtn" class="btn btn-primary btn-small">
                        <i class="fas fa-plus"></i> New
                    </button>
                </div>
                
                <div class="sidebar-search">
                    <input type="text" id="commandSearch" placeholder="Search commands...">
                    <i class="fas fa-search"></i>
                </div>

                <div id="commandsList" class="commands-list">
                    <!-- Commands will be loaded here -->
                </div>

                <div id="emptyCommands" class="empty-state" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <p>No commands yet</p>
                    <button class="btn btn-primary btn-small" id="addFirstCommand">
                        Create First Command
                    </button>
                </div>
            </div>

            <!-- Main Editor -->
            <div class="editor-main">
                <!-- No Command Selected -->
                <div id="noCommandSelected" class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <h3>No Command Selected</h3>
                    <p>Select a command from the list or create a new one to start editing</p>
                    <button class="btn btn-primary" id="createFirstCommand">
                        <i class="fas fa-plus"></i> Create New Command
                    </button>
                </div>

                <!-- Command Editor -->
                <div id="commandEditor" class="command-editor" style="display: none;">
                    <div class="editor-header">
                        <div class="command-title">
                            <h3 id="currentCommandName">Command Editor</h3>
                            <div class="command-status">
                                <span class="status-badge active" id="commandStatus">Active</span>
                                <span class="command-id" id="commandId">ID: loading...</span>
                            </div>
                        </div>
                        <div class="editor-actions">
                            <button id="toggleCommandBtn" class="btn btn-warning btn-small">
                                <i class="fas fa-power-off"></i> Toggle
                            </button>
                            <button id="testCommandBtn" class="btn btn-success btn-small">
                                <i class="fas fa-bolt"></i> Test
                            </button>
                            <button id="saveCommandBtn" class="btn btn-primary btn-small">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button id="deleteCommandBtn" class="btn btn-danger btn-small">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>

                    <form id="commandForm" class="command-form">
                        <!-- Command Patterns -->
                        <div class="form-section">
                            <h4>Command Patterns</h4>
                            <div class="form-group">
                                <label for="moreCommands">Command Patterns *</label>
                                <div class="commands-input-container">
                                    <div id="commandsTags" class="commands-tags">
                                        <!-- Command tags will be added here -->
                                    </div>
                                    <input type="text" id="moreCommands" 
                                           placeholder="Type command pattern and press Enter or comma...">
                                </div>
                                <div class="form-help">
                                    Add multiple command patterns separated by commas. All patterns will execute the same code.
                                    Example: /start, start, hello
                                </div>
                            </div>
                        </div>

                        <!-- Code Editor Section -->
                        <div class="form-section">
                            <h4>Command Code</h4>
                            <div class="form-group">
                                <div class="code-editor-header">
                                    <label for="commandCode">Command Code *</label>
                                    <div class="code-actions">
                                        <button type="button" class="btn-code" id="openEditor">
                                            <i class="fas fa-edit"></i> Full Editor
                                        </button>
                                        <button type="button" class="btn-code" id="showTemplates">
                                            <i class="fas fa-layer-group"></i> Templates
                                        </button>
                                    </div>
                                </div>
                                <div class="code-editor-container">
                                    <textarea id="commandCode" 
                                              placeholder="Write your command code here..."></textarea>
                                </div>
                                <div class="code-help">
                                    <strong>Available Functions:</strong> bot.sendMessage(), User.saveData(), waitForAnswer(), HTTP.get(), etc.
                                </div>
                            </div>
                        </div>

                        <!-- Test Section -->
                        <div class="test-input-section">
                            <h4>Test Command</h4>
                            <div class="test-input-group">
                                <div class="form-group">
                                    <label for="testInput">Test Input</label>
                                    <input type="text" id="testInput" 
                                           placeholder="Type command like /start or /echo Hello...">
                                </div>
                                <button type="button" id="runTestBtn" class="btn btn-primary">
                                    <i class="fas fa-play"></i> Run Test
                                </button>
                            </div>
                            <div class="test-examples">
                                <strong>Examples:</strong> 
                                <code>/start</code>, 
                                <code>/echo Hello World</code>, 
                                <code>/info</code>, 
                                <code>help</code>
                            </div>
                        </div>

                        <!-- Advanced Options -->
                        <div class="form-section">
                            <h4>Advanced Options</h4>
                            <div class="toggle-group">
                                <label class="toggle-label">
                                    <div class="toggle-text">
                                        <span class="toggle-title">Wait for Answer</span>
                                        <span class="toggle-description">Enable to wait for user response after command execution</span>
                                    </div>
                                    <div class="toggle-switch">
                                        <input type="checkbox" id="waitForAnswer">
                                        <span class="toggle-slider"></span>
                                    </div>
                                </label>
                            </div>

                            <div id="answerHandlerSection" class="form-group" style="display: none;">
                                <div class="code-editor-header">
                                    <label for="answerHandler">Answer Handler Code</label>
                                    <div class="code-actions">
                                        <button type="button" class="btn-code" id="openAnswerEditor">
                                            <i class="fas fa-edit"></i> Full Editor
                                        </button>
                                    </div>
                                </div>
                                <div class="code-editor-container">
                                    <textarea id="answerHandler" 
                                              placeholder="Code to handle user's answer..."></textarea>
                                </div>
                                <div class="form-help">
                                    This code will execute when user responds. Use waitForAnswer() to get user's response.
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Test Command Modal -->
    <div id="testCommandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Test Results</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="testCommandResult">
                    <div class="test-loading">
                        <div class="spinner"></div>
                        <p>Testing command execution...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeTestCommand">Close</button>
                <button class="btn btn-primary" id="copyResultBtn">
                    <i class="fas fa-copy"></i> Copy Result
                </button>
            </div>
        </div>
    </div>

    <!-- Full Screen Code Editor Modal -->
    <div id="codeEditorModal" class="modal fullscreen-modal">
        <div class="modal-content fullscreen-content">
            <div class="modal-header compact-header">
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button class="btn-icon" id="undoBtn" title="Undo">
                            <i class="fas fa-undo"></i>
                            <span>Undo</span>
                        </button>
                        <button class="btn-icon" id="redoBtn" title="Redo">
                            <i class="fas fa-redo"></i>
                            <span>Redo</span>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn-icon" id="selectAllBtn" title="Select All">
                            <i class="fas fa-expand-arrows-alt"></i>
                            <span>Select All</span>
                        </button>
                        <button class="btn-icon" id="cutBtn" title="Cut">
                            <i class="fas fa-cut"></i>
                            <span>Cut</span>
                        </button>
                        <button class="btn-icon" id="copyBtn" title="Copy">
                            <i class="fas fa-copy"></i>
                            <span>Copy</span>
                        </button>
                        <button class="btn-icon" id="pasteBtn" title="Paste">
                            <i class="fas fa-paste"></i>
                            <span>Paste</span>
                        </button>
                    </div>
                    <div class="toolbar-group">
                        <button class="btn-icon" id="clearBtn" title="Clear All">
                            <i class="fas fa-eraser"></i>
                            <span>Clear</span>
                        </button>
                        <button class="btn-icon" id="formatBtn" title="Format Code">
                            <i class="fas fa-indent"></i>
                            <span>Format</span>
                        </button>
                    </div>
                </div>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body fullscreen-body">
                <textarea id="advancedCodeEditor" class="fullscreen-editor" 
                         placeholder="Write your code here..."></textarea>
            </div>
            <div class="modal-footer">
                <div class="editor-info">
                    <span id="lineCount">Line: 1</span>
                    <span id="charCount">Chars: 0</span>
                    <span id="editorType">Editor: Main Code</span>
                </div>
                <div class="editor-actions">
                    <button class="btn btn-secondary" id="cancelEdit">Cancel</button>
                    <button class="btn btn-primary" id="saveCode">Save Code</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Modal -->
    <div id="templatesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Code Templates</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="templates-categories">
                    <div class="category-tabs">
                        <button class="category-tab active" data-category="basic">Basic</button>
                        <button class="category-tab" data-category="interactive">Interactive</button>
                        <button class="category-tab" data-category="media">Media</button>
                        <button class="category-tab" data-category="buttons">Buttons</button>
                        <button class="category-tab" data-category="data">Data</button>
                        <button class="category-tab" data-category="http">HTTP</button>
                        <button class="category-tab" data-category="advanced">Advanced</button>
                    </div>
                    
                    <div class="templates-content">
                        <div class="template-loading">
                            <div class="spinner"></div>
                            <p>Loading templates from server...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeTemplates">Close</button>
                <button class="btn btn-primary" id="refreshTemplates">
                    <i class="fas fa-sync-alt"></i> Refresh Templates
                </button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        // Complete Command Editor JavaScript
        class CommandEditor {
            constructor() {
                this.user = null;
                this.currentBot = null;
                this.currentCommand = null;
                this.commands = [];
                this.templates = {};
                this.currentEditorType = 'main';
                this.init();
            }

            async init() {
                await this.checkAuth();
                await this.loadBotInfo();
                this.setupEventListeners();
                await this.loadCommands();
                this.setupCodeEditor();
                this.setupCommandsTags();
                this.setupCommandListClick();
            }

            async checkAuth() {
                const token = localStorage.getItem('token');
                const userData = localStorage.getItem('user');
                if (!token || !userData) {
                    window.location.href = 'login.html';
                    return;
                }
                try {
                    this.user = JSON.parse(userData);
                    this.updateUserInfo();
                } catch (error) {
                    this.logout();
                }
            }

            updateUserInfo() {
                document.getElementById('userEmail').textContent = this.user.email;
                document.getElementById('userAvatar').textContent = this.user.email.charAt(0).toUpperCase();
            }

            async loadBotInfo() {
                const urlParams = new URLSearchParams(window.location.search);
                const botId = urlParams.get('bot');

                if (!botId) {
                    this.showError('No bot specified');
                    window.location.href = 'bot-management.html';
                    return;
                }

                try {
                    // Simulate API call - replace with actual API
                    this.currentBot = {
                        id: botId,
                        name: "Demo Bot",
                        username: "demobot",
                        token: "demo_token_123"
                    };
                    
                    this.updateBotInfo();
                } catch (error) {
                    this.showError('Failed to load bot info');
                }
            }

            updateBotInfo() {
                if (this.currentBot) {
                    document.getElementById('botName').textContent = `Commands - ${this.currentBot.name}`;
                    document.getElementById('botUsername').textContent = `@${this.currentBot.username}`;
                }
            }

            async loadCommands() {
                if (!this.currentBot) return;

                this.showLoading(true);

                try {
                    // Simulate API call - replace with actual API
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    this.commands = [
                        {
                            id: '1',
                            command_patterns: '/start,start,hello',
                            code: `const user = getUser();
const chatId = getChatId();

// Welcome message
bot.sendMessage(chatId, \\`ðŸŽ‰ Hello \\${user.first_name}! Welcome to our bot!\\n\\nðŸ¤– I can help you with:\\n/start - Show this welcome message\\n/help - Get help\\n/info - Bot information\\n\\nChoose a command or type your message!\\`);`,
                            is_active: true,
                            wait_for_answer: false,
                            answer_handler: ''
                        },
                        {
                            id: '2', 
                            command_patterns: '/help,help,commands',
                            code: `const commands = [
    "/start - Welcome message",
    "/help - Show this help", 
    "/info - Bot information",
    "/echo [text] - Repeat your message"
].join('\\\\n');

bot.sendMessage(getChatId(), \\`ðŸ¤– **Available Commands:**\\\\n\\\\n\\${commands}\\`);`,
                            is_active: true,
                            wait_for_answer: false,
                            answer_handler: ''
                        },
                        {
                            id: '3',
                            command_patterns: '/echo,repeat,say',
                            code: `const message = getMessageText();
const args = message.split(' ').slice(1).join(' ');

if (args) {
    bot.sendMessage(getChatId(), \\`ðŸ”Š You said: \\${args}\\`);
} else {
    bot.sendMessage(getChatId(), "Please provide text to echo! Example: /echo Hello World");
}`,
                            is_active: true,
                            wait_for_answer: false,
                            answer_handler: ''
                        }
                    ];
                    
                    this.displayCommands();
                } catch (error) {
                    this.showError('Failed to load commands');
                } finally {
                    this.showLoading(false);
                }
            }

            displayCommands() {
                const commandsList = document.getElementById('commandsList');
                const emptyCommands = document.getElementById('emptyCommands');
                const noCommandSelected = document.getElementById('noCommandSelected');

                if (!this.commands || this.commands.length === 0) {
                    commandsList.style.display = 'none';
                    emptyCommands.style.display = 'block';
                    noCommandSelected.style.display = 'block';
                    document.getElementById('commandEditor').style.display = 'none';
                    return;
                }

                commandsList.style.display = 'block';
                emptyCommands.style.display = 'none';

                let html = '';
                this.commands.forEach(command => {
                    const isActive = command.is_active;
                    const isSelected = this.currentCommand?.id === command.id;
                    const patterns = command.command_patterns.split(',').slice(0, 2).join(', ');
                    
                    html += `
                        <div class="command-group ${isSelected ? 'active' : ''}" 
                             data-command-id="${command.id}">
                            <div class="command-content">
                                <div class="command-patterns">${this.escapeHtml(patterns)}</div>
                                <div class="command-meta">
                                    <span class="command-status ${isActive ? 'active' : 'inactive'}">
                                        <i class="fas fa-circle"></i>
                                        ${isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                commandsList.innerHTML = html;
            }

            setupCommandListClick() {
                document.addEventListener('click', (e) => {
                    const commandGroup = e.target.closest('.command-group');
                    if (commandGroup) {
                        const commandId = commandGroup.dataset.commandId;
                        this.selectCommand(commandId);
                    }
                });
            }

            async selectCommand(commandId) {
                if (this.currentCommand?.id === commandId) return;

                this.showLoading(true);

                try {
                    // Find command in local array
                    const command = this.commands.find(cmd => cmd.id === commandId);
                    if (command) {
                        this.currentCommand = command;
                        this.showCommandEditor();
                        this.populateCommandForm();
                        
                        // Update UI selection
                        document.querySelectorAll('.command-group').forEach(group => {
                            group.classList.remove('active');
                        });
                        
                        const selectedGroup = document.querySelector(`[data-command-id="${commandId}"]`);
                        if (selectedGroup) {
                            selectedGroup.classList.add('active');
                        }
                    } else {
                        this.showError('Command not found');
                    }
                } catch (error) {
                    this.showError('Failed to load command');
                } finally {
                    this.showLoading(false);
                }
            }

            setupEventListeners() {
                // Navigation
                document.getElementById('backToBots').addEventListener('click', () => {
                    window.location.href = 'bot-management.html';
                });

                document.getElementById('quickTest').addEventListener('click', () => {
                    this.quickTest();
                });

                // Command actions
                document.getElementById('addCommandBtn').addEventListener('click', () => {
                    this.addNewCommand();
                });

                document.getElementById('createFirstCommand').addEventListener('click', () => {
                    this.addNewCommand();
                });

                document.getElementById('addFirstCommand').addEventListener('click', () => {
                    this.addNewCommand();
                });

                // Form actions
                document.getElementById('saveCommandBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.saveCommand();
                });

                document.getElementById('deleteCommandBtn').addEventListener('click', () => {
                    this.deleteCommand();
                });

                document.getElementById('toggleCommandBtn').addEventListener('click', () => {
                    this.toggleCommand();
                });

                document.getElementById('testCommandBtn').addEventListener('click', () => {
                    this.testCommand();
                });

                document.getElementById('runTestBtn').addEventListener('click', () => {
                    this.runCustomTest();
                });

                // Toggle switches
                document.getElementById('waitForAnswer').addEventListener('change', (e) => {
                    this.toggleAnswerHandler(e.target.checked);
                });

                // Code editor buttons
                document.getElementById('openEditor').addEventListener('click', () => {
                    this.openCodeEditor('main');
                });

                document.getElementById('openAnswerEditor').addEventListener('click', () => {
                    this.openCodeEditor('answer');
                });

                // Templates
                document.getElementById('showTemplates').addEventListener('click', async () => {
                    await this.showTemplates();
                });

                document.getElementById('refreshTemplates').addEventListener('click', async () => {
                    await this.loadTemplatesFromServer();
                });

                // Search
                let searchTimeout;
                document.getElementById('commandSearch').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.filterCommands(e.target.value);
                    }, 300);
                });

                // Copy result button
                document.getElementById('copyResultBtn').addEventListener('click', () => {
                    this.copyTestResult();
                });

                // Modal events
                this.setupModalEvents();
                this.setupTemplateCategories();

                // Enter key for test input
                document.getElementById('testInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.runCustomTest();
                    }
                });
            }

            setupModalEvents() {
                const modals = ['testCommandModal', 'codeEditorModal', 'templatesModal'];
                
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    const closeBtn = modal?.querySelector('.modal-close');
                    
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => {
                            modal.style.display = 'none';
                        });
                    }
                });

                document.getElementById('closeTestCommand')?.addEventListener('click', () => {
                    document.getElementById('testCommandModal').style.display = 'none';
                });

                document.getElementById('closeTemplates')?.addEventListener('click', () => {
                    document.getElementById('templatesModal').style.display = 'none';
                });

                // Template card click events
                document.addEventListener('click', (e) => {
                    const templateCard = e.target.closest('.template-card');
                    if (templateCard) {
                        const templateData = templateCard.dataset.template;
                        if (templateData) {
                            try {
                                const template = JSON.parse(templateData);
                                this.applyTemplate(template);
                            } catch (error) {
                                console.error('Error parsing template:', error);
                            }
                        }
                    }
                });

                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }

            setupTemplateCategories() {
                const categoryTabs = document.querySelectorAll('.category-tab');

                categoryTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const category = tab.dataset.category;
                        
                        // Update tabs
                        categoryTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Update content
                        const templateCategories = document.querySelectorAll('.template-category');
                        templateCategories.forEach(cat => cat.classList.remove('active'));
                        
                        const targetCategory = document.getElementById(`${category}-templates`);
                        if (targetCategory) {
                            targetCategory.classList.add('active');
                        }
                    });
                });
            }

            async loadTemplatesFromServer() {
                try {
                    const token = localStorage.getItem('token');
                    const response = await fetch('/api/templates', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.templates = data.templates;
                            this.populateTemplatesModal();
                            return true;
                        }
                    }
                    throw new Error('Failed to load templates');
                } catch (error) {
                    console.error('Load templates error:', error);
                    // Fallback to local templates if server fails
                    this.loadLocalTemplates();
                    return true;
                }
            }

            loadLocalTemplates() {
                // Fallback templates if server is not available
                this.templates = {
                    basic: [
                        {
                            name: "Welcome Message",
                            patterns: "/start, start, hello",
                            code: `const user = getUser();\nconst chatId = getChatId();\n\nbot.sendMessage(chatId, \\`ðŸŽ‰ Hello \\${user.first_name}! Welcome to our bot!\\n\\nðŸ¤– I can help you with:\\n/start - Show this welcome message\\n/help - Get help\\n/info - Bot information\\n\\nChoose a command or type your message!\\`);`,
                            description: "Simple welcome message with user info"
                        },
                        {
                            name: "Echo Command", 
                            patterns: "/echo, repeat, say",
                            code: `const message = getMessageText();\nconst args = message.split(' ').slice(1).join(' ');\n\nif (args) {\n    bot.sendMessage(getChatId(), \\`ðŸ”Š You said: \\${args}\\`);\n} else {\n    bot.sendMessage(getChatId(), "Please provide text to echo! Example: /echo Hello World");\n}`,
                            description: "Repeat user's message back"
                        }
                    ],
                    interactive: [
                        {
                            name: "Interactive Conversation",
                            patterns: "/conversation, chat, talk", 
                            code: `bot.sendMessage(getChatId(), "Let's have a conversation! What's your name?");\n\n// Enable Wait for Answer and use this in Answer Handler:\nconst userName = getUserResponse();\nbot.sendMessage(getChatId(), \\`Nice to meet you, \\${userName}! How can I help you today?\\`);`,
                            description: "Multiple questions with wait for answer",
                            waitForAnswer: true
                        }
                    ]
                };
                
                this.populateTemplatesModal();
            }

            populateTemplatesModal() {
                const templatesContent = document.querySelector('.templates-content');
                if (!templatesContent) return;

                if (!this.templates || Object.keys(this.templates).length === 0) {
                    templatesContent.innerHTML = `
                        <div class="template-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>No templates available</p>
                        </div>
                    `;
                    return;
                }

                let html = '';

                for (const [category, templates] of Object.entries(this.templates)) {
                    const categoryId = `${category}-templates`;
                    const isActive = category === 'basic' ? 'active' : '';
                    
                    html += `
                        <div id="${categoryId}" class="template-category ${isActive}">
                            <div class="templates-grid">
                                ${templates.map(template => `
                                    <div class="template-card" data-template='${JSON.stringify(template).replace(/'/g, "&#39;")}'>
                                        <div class="template-icon">
                                            <i class="fas fa-${this.getTemplateIcon(category)}"></i>
                                        </div>
                                        <h4>${this.escapeHtml(template.name)}</h4>
                                        <p>${this.escapeHtml(template.description)}</p>
                                        <div class="template-preview">
                                            <strong>Patterns:</strong> ${this.escapeHtml(template.patterns)}
                                            <div class="template-code-preview">
                                                ${this.escapeHtml(template.code.substring(0, 100))}...
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                templatesContent.innerHTML = html;
            }

            getTemplateIcon(category) {
                const icons = {
                    'basic': 'code',
                    'interactive': 'comments',
                    'media': 'image',
                    'buttons': 'th',
                    'data': 'database', 
                    'http': 'cloud',
                    'advanced': 'cogs'
                };
                return icons[category] || 'code';
            }

            async showTemplates() {
                // Show loading state
                const templatesContent = document.querySelector('.templates-content');
                if (templatesContent) {
                    templatesContent.innerHTML = `
                        <div class="template-loading">
                            <div class="spinner"></div>
                            <p>Loading templates from server...</p>
                        </div>
                    `;
                }

                // Load templates from server
                await this.loadTemplatesFromServer();
                document.getElementById('templatesModal').style.display = 'flex';
            }

            applyTemplate(template) {
                this.setCommandsToTags(template.patterns);
                document.getElementById('commandCode').value = template.code;
                
                if (template.waitForAnswer) {
                    document.getElementById('waitForAnswer').checked = true;
                    this.toggleAnswerHandler(true);
                    document.getElementById('answerHandler').value = template.answerHandler || '';
                } else {
                    document.getElementById('waitForAnswer').checked = false;
                    this.toggleAnswerHandler(false);
                }
                
                document.getElementById('templatesModal').style.display = 'none';
                this.showSuccess('Template applied successfully!');
            }

            addNewCommand() {
                this.currentCommand = {
                    id: 'new',
                    command_patterns: '/start',
                    code: `// Write your command code here\nconst user = getUser();\nconst chatId = getChatId();\n\nbot.sendMessage(chatId, \\`Hello \\${user.first_name}! Welcome to our bot!\\`);`,
                    is_active: true,
                    wait_for_answer: false,
                    answer_handler: ''
                };

                this.showCommandEditor();
                this.populateCommandForm();
                
                // Clear and focus on command patterns
                this.setCommandsToTags(['/start']);
                setTimeout(() => {
                    document.getElementById('moreCommands').focus();
                }, 100);
            }

            showCommandEditor() {
                document.getElementById('noCommandSelected').style.display = 'none';
                document.getElementById('commandEditor').style.display = 'block';
            }

            hideCommandEditor() {
                document.getElementById('noCommandSelected').style.display = 'block';
                document.getElementById('commandEditor').style.display = 'none';
                this.currentCommand = null;
            }

            populateCommandForm() {
                if (!this.currentCommand) return;
                
                this.setCommandsToTags(this.currentCommand.command_patterns);
                document.getElementById('commandCode').value = this.currentCommand.code;
                
                const waitToggle = document.getElementById('waitForAnswer');
                if (waitToggle) {
                    waitToggle.checked = this.currentCommand.wait_for_answer || false;
                    this.toggleAnswerHandler(waitToggle.checked);
                }
                
                document.getElementById('answerHandler').value = this.currentCommand.answer_handler || '';
                document.getElementById('commandId').textContent = `ID: ${this.currentCommand.id}`;
                
                const statusBadge = document.getElementById('commandStatus');
                statusBadge.textContent = this.currentCommand.is_active ? 'Active' : 'Inactive';
                statusBadge.className = `status-badge ${this.currentCommand.is_active ? 'active' : 'inactive'}`;
                
                this.updateButtonStates();
            }

            updateButtonStates() {
                const isNew = this.currentCommand?.id === 'new';
                const deleteBtn = document.getElementById('deleteCommandBtn');
                const toggleBtn = document.getElementById('toggleCommandBtn');
                
                if (deleteBtn) {
                    deleteBtn.disabled = isNew;
                    deleteBtn.style.opacity = isNew ? '0.5' : '1';
                }
                
                if (toggleBtn) {
                    toggleBtn.innerHTML = `<i class="fas fa-power-off"></i> ${this.currentCommand?.is_active ? 'Deactivate' : 'Activate'}`;
                }
            }

            setupCommandsTags() {
                const moreCommandsInput = document.getElementById('moreCommands');
                const commandsTags = document.getElementById('commandsTags');

                moreCommandsInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ',') {
                        e.preventDefault();
                        const command = moreCommandsInput.value.trim();
                        if (command) {
                            this.addCommandTag(command);
                            moreCommandsInput.value = '';
                        }
                    }
                });

                moreCommandsInput.addEventListener('blur', () => {
                    const command = moreCommandsInput.value.trim();
                    if (command) {
                        this.addCommandTag(command);
                        moreCommandsInput.value = '';
                    }
                });

                // Handle paste event
                moreCommandsInput.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedText = e.clipboardData.getData('text');
                    const commands = pastedText.split(',').map(cmd => cmd.trim()).filter(cmd => cmd);
                    
                    commands.forEach(command => {
                        if (command && !this.commandExistsInTags(command)) {
                            this.addCommandTag(command);
                        }
                    });
                    
                    moreCommandsInput.value = '';
                });
            }

            addCommandTag(command) {
                if (!command || this.commandExistsInTags(command)) return;

                const commandsTags = document.getElementById('commandsTags');
                const tag = document.createElement('div');
                tag.className = 'command-tag';
                tag.innerHTML = `
                    <span class="tag-text">${this.escapeHtml(command)}</span>
                    <button type="button" class="remove-tag">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                tag.querySelector('.remove-tag').addEventListener('click', () => {
                    tag.remove();
                });
                
                commandsTags.appendChild(tag);
            }

            commandExistsInTags(command) {
                const tags = Array.from(document.querySelectorAll('.command-tag .tag-text'));
                return tags.some(tag => tag.textContent.trim() === command);
            }

            getCommandsFromTags() {
                const tags = Array.from(document.querySelectorAll('.command-tag .tag-text'));
                return tags.map(tag => tag.textContent.trim()).filter(cmd => cmd);
            }

            setCommandsToTags(commands) {
                const commandsTags = document.getElementById('commandsTags');
                commandsTags.innerHTML = '';
                
                if (typeof commands === 'string') {
                    commands = commands.split(',').map(cmd => cmd.trim()).filter(cmd => cmd);
                }
                
                commands.forEach(command => {
                    if (command) {
                        this.addCommandTag(command);
                    }
                });
            }

            toggleAnswerHandler(show) {
                const section = document.getElementById('answerHandlerSection');
                section.style.display = show ? 'block' : 'none';
            }

            setupCodeEditor() {
                const advancedEditor = document.getElementById('advancedCodeEditor');
                
                document.getElementById('cancelEdit').addEventListener('click', () => {
                    this.closeCodeEditor();
                });

                document.getElementById('saveCode').addEventListener('click', () => {
                    this.saveCodeFromEditor();
                });

                // Editor toolbar functionality
                document.getElementById('undoBtn').addEventListener('click', () => {
                    document.execCommand('undo');
                });

                document.getElementById('redoBtn').addEventListener('click', () => {
                    document.execCommand('redo');
                });

                document.getElementById('selectAllBtn').addEventListener('click', () => {
                    advancedEditor.select();
                });

                document.getElementById('cutBtn').addEventListener('click', () => {
                    document.execCommand('cut');
                });

                document.getElementById('copyBtn').addEventListener('click', () => {
                    document.execCommand('copy');
                });

                document.getElementById('pasteBtn').addEventListener('click', async () => {
                    try {
                        const text = await navigator.clipboard.readText();
                        advancedEditor.value += text;
                    } catch (error) {
                        document.execCommand('paste');
                    }
                });

                document.getElementById('clearBtn').addEventListener('click', () => {
                    advancedEditor.value = '';
                    this.updateLineCount('');
                });

                document.getElementById('formatBtn').addEventListener('click', () => {
                    this.formatCode(advancedEditor);
                });

                advancedEditor.addEventListener('input', (e) => {
                    this.updateLineCount(e.target.value);
                });

                this.updateLineCount(advancedEditor.value);
            }

            updateLineCount(code) {
                const lines = code.split('\n').length;
                const chars = code.length;
                document.getElementById('lineCount').textContent = `Line: ${lines}`;
                document.getElementById('charCount').textContent = `Chars: ${chars}`;
            }

            formatCode(textarea) {
                // Simple code formatting
                let code = textarea.value;
                
                // Basic indentation
                code = code.replace(/\{/g, ' {\n    ')
                          .replace(/\}/g, '\n}\n')
                          .replace(/;\s*/g, ';\n    ')
                          .replace(/\n\s*\n/g, '\n');
                
                textarea.value = code;
                this.updateLineCount(code);
            }

            openCodeEditor(editorType) {
                this.currentEditorType = editorType;
                let code = '';
                
                if (editorType === 'main') {
                    code = document.getElementById('commandCode').value;
                    document.getElementById('editorType').textContent = 'Editor: Main Code';
                } else if (editorType === 'answer') {
                    code = document.getElementById('answerHandler').value;
                    document.getElementById('editorType').textContent = 'Editor: Answer Handler';
                }
                
                document.getElementById('advancedCodeEditor').value = code;
                this.updateLineCount(code);
                document.getElementById('codeEditorModal').style.display = 'flex';
                
                setTimeout(() => {
                    const editor = document.getElementById('advancedCodeEditor');
                    editor.focus();
                    editor.setSelectionRange(0, 0);
                }, 100);
            }

            closeCodeEditor() {
                document.getElementById('codeEditorModal').style.display = 'none';
            }

            saveCodeFromEditor() {
                const code = document.getElementById('advancedCodeEditor').value;
                
                if (this.currentEditorType === 'main') {
                    document.getElementById('commandCode').value = code;
                } else if (this.currentEditorType === 'answer') {
                    document.getElementById('answerHandler').value = code;
                }
                
                this.closeCodeEditor();
                this.showSuccess('Code saved successfully!');
            }

            async saveCommand() {
                if (!this.currentCommand || !this.currentBot) {
                    this.showError('No command selected or bot not loaded');
                    return false;
                }

                const commands = this.getCommandsFromTags();
                
                if (commands.length === 0) {
                    this.showError('Please add at least one command pattern');
                    document.getElementById('moreCommands').focus();
                    return false;
                }

                const commandCode = document.getElementById('commandCode').value.trim();
                if (!commandCode) {
                    this.showError('Command code is required');
                    document.getElementById('commandCode').focus();
                    return false;
                }

                const waitForAnswer = document.getElementById('waitForAnswer').checked;
                const answerHandler = waitForAnswer ? document.getElementById('answerHandler').value.trim() : '';

                if (waitForAnswer && !answerHandler) {
                    this.showError('Answer handler code is required when "Wait for Answer" is enabled');
                    document.getElementById('answerHandler').focus();
                    return false;
                }

                this.showLoading(true);

                try {
                    const commandData = {
                        command_patterns: commands.join(','),
                        code: commandCode,
                        wait_for_answer: waitForAnswer,
                        answer_handler: answerHandler,
                        bot_token: this.currentBot.token,
                        is_active: this.currentCommand.is_active
                    };

                    // Simulate API call - replace with actual API
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Update local command
                    if (this.currentCommand.id === 'new') {
                        this.currentCommand.id = Date.now().toString();
                        this.commands.push({...commandData, id: this.currentCommand.id});
                    } else {
                        const index = this.commands.findIndex(cmd => cmd.id === this.currentCommand.id);
                        if (index !== -1) {
                            this.commands[index] = {...this.commands[index], ...commandData};
                        }
                    }

                    this.showSuccess('Command saved successfully!');
                    await this.loadCommands();
                    
                    // Re-select the command
                    setTimeout(() => {
                        this.selectCommand(this.currentCommand.id);
                    }, 500);
                    
                    return true;
                } catch (error) {
                    this.showError('Failed to save command: ' + error.message);
                    return false;
                } finally {
                    this.showLoading(false);
                }
            }

            async deleteCommand() {
                if (!this.currentCommand || this.currentCommand.id === 'new') {
                    return;
                }

                if (!confirm('Are you sure you want to delete this command?\n\nThis action cannot be undone.')) {
                    return;
                }

                this.showLoading(true);

                try {
                    // Simulate API call - replace with actual API
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Remove from local array
                    this.commands = this.commands.filter(cmd => cmd.id !== this.currentCommand.id);
                    
                    this.showSuccess('Command deleted successfully');
                    this.hideCommandEditor();
                    await this.loadCommands();
                } catch (error) {
                    this.showError('Failed to delete command');
                } finally {
                    this.showLoading(false);
                }
            }

            async toggleCommand() {
                if (!this.currentCommand || this.currentCommand.id === 'new') {
                    return;
                }

                const newStatus = !this.currentCommand.is_active;

                this.showLoading(true);

                try {
                    // Simulate API call - replace with actual API
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Update local status
                    this.currentCommand.is_active = newStatus;
                    const index = this.commands.findIndex(cmd => cmd.id === this.currentCommand.id);
                    if (index !== -1) {
                        this.commands[index].is_active = newStatus;
                    }
                    
                    this.populateCommandForm();
                    await this.loadCommands();
                    this.showSuccess(`Command ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                } catch (error) {
                    this.showError('Failed to toggle command status');
                } finally {
                    this.showLoading(false);
                }
            }

            async testCommand() {
                if (!this.currentBot) {
                    this.showError('Bot information not loaded');
                    return;
                }

                const commands = this.getCommandsFromTags();
                if (commands.length === 0) {
                    this.showError('Please add at least one command to test');
                    return;
                }

                const commandCode = document.getElementById('commandCode').value.trim();
                if (!commandCode) {
                    this.showError('Please add command code to test');
                    return;
                }

                // Use first command pattern for testing
                const testInput = commands[0];
                await this.executeTest(testInput, commandCode);
            }

            async runCustomTest() {
                if (!this.currentBot) {
                    this.showError('Bot information not loaded');
                    return;
                }

                const testInput = document.getElementById('testInput').value.trim();
                if (!testInput) {
                    this.showError('Please enter test input');
                    document.getElementById('testInput').focus();
                    return;
                }

                const commandCode = document.getElementById('commandCode').value.trim();
                if (!commandCode) {
                    this.showError('Please add command code to test');
                    return;
                }

                await this.executeTest(testInput, commandCode);
            }

            async executeTest(testInput, commandCode) {
                this.showTestModal();
                this.showTestLoading();

                try {
                    // Simulate API call - replace with actual API
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Simulate command execution based on input
                    const userMessage = testInput;
                    let botResponse = this.simulateCommandExecution(userMessage, commandCode);
                    
                    this.showTestResult(userMessage, botResponse);
                } catch (error) {
                    this.showTestError(`
âŒ Test Failed

Error: ${error.message}
Please check your command code and try again.
                    `);
                }
            }

            simulateCommandExecution(userMessage, commandCode) {
                // Simple simulation of command execution
                if (userMessage.includes('/start') || userMessage.toLowerCase().includes('start') || userMessage.toLowerCase().includes('hello')) {
                    return "ðŸŽ‰ Welcome to our bot! How can I help you today?";
                } else if (userMessage.includes('/help') || userMessage.toLowerCase().includes('help')) {
                    return "ðŸ¤– Available commands:\n/start - Welcome message\n/help - Show this help\n/info - Bot information\n/echo [text] - Repeat your message";
                } else if (userMessage.includes('/info') || userMessage.toLowerCase().includes('info')) {
                    return `â„¹ï¸ Bot Information:\nName: ${this.currentBot.name}\nUsername: @${this.currentBot.username}\nStatus: Active`;
                } else if (userMessage.includes('/echo')) {
                    const args = userMessage.split(' ').slice(1).join(' ');
                    if (args) {
                        return `ðŸ”Š You said: ${args}`;
                    } else {
                        return "Please provide text to echo! Example: /echo Hello World";
                    }
                } else {
                    return "ðŸ¤” I didn't understand that command. Type /help to see available commands.";
                }
            }

            showTestResult(userMessage, botResponse) {
                const resultDiv = document.getElementById('testCommandResult');
                resultDiv.innerHTML = `
                    <div class="test-success">
                        <div class="result-header">
                            <h4>âœ… Test Completed Successfully</h4>
                        </div>
                        
                        <div class="telegram-message message-user">
                            <div class="message-header">
                                <span>ðŸ‘¤ You</span>
                                <span>${new Date().toLocaleTimeString()}</span>
                            </div>
                            <div class="message-content">${userMessage}</div>
                        </div>
                        
                        <div class="telegram-message message-bot">
                            <div class="message-header">
                                <span>ðŸ¤– ${this.currentBot.name}</span>
                                <span>${new Date().toLocaleTimeString()}</span>
                            </div>
                            <div class="message-content">${botResponse}</div>
                        </div>
                        
                        <div class="test-result-container">
                            <div class="test-result-content">
ðŸ“‹ Test Details:
â”œ Input: "${userMessage}"
â”œ Bot: ${this.currentBot.name}
â”œ Status: Command executed successfully
â”” Time: ${new Date().toLocaleString()}

ðŸ” Execution Summary:
The command was processed successfully and the bot responded as expected.
                            </div>
                        </div>
                        
                        <button class="copy-btn" onclick="commandEditor.copyTestResult()">
                            <i class="fas fa-copy"></i> Copy Test Result
                        </button>
                    </div>
                `;
            }

            quickTest() {
                if (this.currentCommand) {
                    this.testCommand();
                } else {
                    this.showError('Please select a command first');
                }
            }

            showTestModal() {
                document.getElementById('testCommandModal').style.display = 'flex';
            }

            showTestLoading() {
                document.getElementById('testCommandResult').innerHTML = `
                    <div class="test-loading">
                        <div class="spinner"></div>
                        <p>Testing command execution...</p>
                    </div>
                `;
            }

            showTestError(html) {
                const resultDiv = document.getElementById('testCommandResult');
                resultDiv.innerHTML = `
                    <div class="test-error">
                        <div class="result-header">
                            <h4>âŒ Test Failed</h4>
                        </div>
                        <div class="test-result-container">
                            <div class="test-result-content">${html}</div>
                        </div>
                        <button class="copy-btn" onclick="commandEditor.copyTestResult()">
                            <i class="fas fa-copy"></i> Copy Error Details
                        </button>
                    </div>
                `;
            }

            copyTestResult() {
                const resultContent = document.querySelector('.test-result-content');
                if (resultContent) {
                    const text = resultContent.textContent || resultContent.innerText;
                    navigator.clipboard.writeText(text).then(() => {
                        this.showSuccess('Test result copied to clipboard!');
                    }).catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showSuccess('Result copied to clipboard!');
                    });
                }
            }

            filterCommands(searchTerm) {
                const commandGroups = document.querySelectorAll('.command-group');
                const lowerSearch = searchTerm.toLowerCase().trim();

                if (!lowerSearch) {
                    commandGroups.forEach(group => group.style.display = 'block');
                    return;
                }

                commandGroups.forEach(group => {
                    const commandPatterns = group.querySelector('.command-patterns').textContent.toLowerCase();
                    const isVisible = commandPatterns.includes(lowerSearch);
                    group.style.display = isVisible ? 'block' : 'none';
                });
            }

            escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = show ? 'flex' : 'none';
                }
            }

            showError(message) {
                if (typeof commonApp !== 'undefined' && commonApp.showError) {
                    commonApp.showError(message);
                } else {
                    alert('Error: ' + message);
                }
            }

            showSuccess(message) {
                if (typeof commonApp !== 'undefined' && commonApp.showSuccess) {
                    commonApp.showSuccess(message);
                } else {
                    alert('Success: ' + message);
                }
            }

            logout() {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // Initialize command editor when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.commandEditor = new CommandEditor();
        });
    </script>
</body>
</html>